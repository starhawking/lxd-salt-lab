# Salt-Reclass Ansible Playbooks

## Requirements
* `Ubuntu 16.04` as the lab's base OS. Earlier releases may still support LXD, however the `14.04` release didn't appear support it. I didn't try anything other than the LTS releases.
* LXD with your resolv.conf configured to use LXD's internal nameservers
I was able to use LXD's nameserver for my base node by adding the IP address of my lab node's `lxdbr0` to `/etc/resolvconf/resolv.conf.d/head`
Adding it to `/etc/resolvconf/resolv.conf.d/head` instead of directly to `/etc/resolv.conf` will allow the setting to persist between reboots.

```shell
ubuntu@lxd-lab01:~/salt-reclass-lab$ cat /etc/resolvconf/resolv.conf.d/head
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
ubuntu@lxd-lab01:~/salt-reclass-lab$ ip -4 addr show dev lxdbr0
4: lxdbr0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000
    inet 10.220.16.1/24 scope global lxdbr0
       valid_lft forever preferred_lft forever
ubuntu@lxd-lab01:~/salt-reclass-lab$ echo "nameserver 10.220.16.1" | sudo tee -a /etc/resolvconf/resolv.conf.d/head
nameserver 10.220.16.1
ubuntu@lxd-lab01:~/salt-reclass-lab$ cat /etc/resolvconf/resolv.conf.d/head
# Dynamic resolv.conf(5) file for glibc resolver(3) generated by resolvconf(8)
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
nameserver 10.220.16.1
```

* Ansible 2.2 installed. This is required to use the Ansible `lxd_container` module. The packege available on the Ansible PPA contains everything needed to run these playbooks.

```shell
$ sudo apt-add-repository ppa:ansible/ansible
$ sudo apt-get update
$ sudo apt-get install ansible
```

## Preparing the Lab
The lab can be built with the following playbooks:

1. `$ time ansible-playbook create_lxc_containers.yml`
2. `$ time ansible-playbook prepare_master.yml`
3. `$ time ansible-playbook prepare_minions.yml`

Each playbook may need to be re-run several times if the container wasn't ready after the previous step.

## Additional Considerations
The playbook to install the salt master overwrites the salt-master.conf upstart script. This was done to work around an issue with setting ulimits inside unprivileged containers in `Ubuntu 14.04`.
It is only necissary to remove the line beginning with `nofile` from `/etc/init/salt-master.conf`, however, the prepare-master playbook will overwrite the entire file.
This issue appears to be resolved when running `Ubuntu 16.04` containers. This isn't much of a concern since these are labs, but it is worth being aware of. 
